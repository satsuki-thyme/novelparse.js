function novelparse(r){function e(){return"unprocessed"===u||"unprocessed"!==u&&"delete-together"!==u?c:"delete-together"===u?c.replace(/\/\*[\s\S]*?(\*\/|$)|\/\/.*(\r?\n|\r(?!\n))/g,"").replace(/^(#+ |[ \t]*[+*-] |[ \t]*\d+\. ).*(\r?\n|\r(?!\n))/gm,"").replace(/^(?=.*(?!\\).:).*(\r?\n|\r(?!\n))/gm,"").replace(/^[ \t]*[./\\].*(\r?\n|\r(?!\n))/gm,""):void 0}async function n(r){function e(){return r.split(/\r?\n|\r(?!\n)/).map(r=>r.replace(/^([^\r\n]+)$/gm,"<p>$1</p>").replace(/^$/gm,"<p><br></p>")).join("\n")}function n(){return r.replace(/^/,"<p>").replace(new RegExp("$(\\r?\\n|\\r(?!\\n)){2}(?!\\r?\\n|\\r(?!\\n))","gm"),"</p><p><br></p><p>").replace(new RegExp(`(${o.join("|")})(\\r?\\n|\\r(?!\\n))`,"g"),"$1</p><p>").replace(/(\r?\n|\r(?!\n)){2,}/g,r=>r.replace(/(\r?\n|\r(?!\n))/g,"<p><br></p>")).replace(/(?!<\/p>)$/,"</p>")}function p(){return r.replace(/^/,"<p>").replace(new RegExp("$(\\r?\\n|\\r(?!\\n))(?!\\r?\\n|\\r(?!\\n))","gm"),"</p><p><br></p><p>").replace(/(\r?\n|\r(?!\n))+/g,r=>r.replace(/(\r?\n|\r(?!\n))/g,"<p><br></p>")).replace(/(?!<\/p>)$/,"</p>")}function a(){return r.replace(/^/,"<p>").replace(new RegExp(`((?!\\r?\\n|\\r(?!\\r)|${o.join("|")}).)(\\r?\\n|\\r(?!\\n)){2}(?!\\r?\\n|\\r(?!\\n)|${g.join("|")})`,"gm"),"$1</p>\n<p>").replace(new RegExp(`$(\\r?\\n|\\r(?!\\n)){2}(?=${g.join("|")})`,"gm"),"</p>\n<p><br></p>\n<p>").replace(new RegExp(`(${o.join("|")})(\\r?\\n|\\r(?!\\n))(?=${g.join("|")})`,"g"),"$1</p>\n<p>").replace(new RegExp(`(${o.join("|")})(\\r?\\n|\\r(?!\\n))`,"g"),"$1</p>\n<p><br></p>\n<p>").replace(/(?!<\/p>)$/,"</p>")}return"normal"===t?e():"few"===t?n():"alternatingBlank"===t?p():"paper"===t?a():"raw"===t||"normal"!==t&&"few"!==t&&"alternatingBlank"!==t&&"paper"!==t?r:void 0}function p(r){return"parse"===l?r.replace(/[|｜](.+?)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)《(.+?)》/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)\(((\p{scx=Hira}|\p{scx=Kana})+)\)/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)（((\p{scx=Hira}|\p{scx=Kana})+)）/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"<ruby>$1<rt>$2</rt></ruby>"):"open"===l?r.replace(/[|｜].+?《(.+?)》/g,"$1").replace(/(?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+《(.+?)》/gu,"$1").replace(/(?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+\(((\p{scx=Hira}|\p{scx=Kana})+)\)/gu,"$1").replace(/(?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+（((\p{scx=Hira}|\p{scx=Kana})+)）/gu,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#.+?__(.+?)__#/g,"$1"):"delete"===l?r.replace(/[|｜](.+?)《(.+?)》/g,"$1").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)《(.+?)》/g,"$1").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)\(((\p{scx=Hira}|\p{scx=Kana})+)\)/gu,"$1").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)（((\p{scx=Hira}|\p{scx=Kana})+)）/gu,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"$1"):"raw"===l?r:void 0}function a(r){function e(r){return r.replace(/(\/|\\|\^|\$|\*|\+|\?|\.|\(|\)|\[|\]|\{|\})/g,"\\$1")}return"string"==typeof r||r instanceof String?e(r):Array.isArray(r)?r.map(r=>e(r)):r}let c=void 0===r.src?"":r.src,t=void 0===r.newLineMode?"normal":r.newLineMode,l=void 0===r.rubyMode?"parse":r.rubyMode,$=(r.parenthesis,[["「","」"],["『","』"],["（","）"]]),g=$.map(r=>a(r[0])),o=$.map(r=>a(r[1])),u=void 0===r.comment?"delete-together":r.comment;return n(e()).then(r=>p(r))}