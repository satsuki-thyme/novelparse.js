function novelparse(e){function r(e){return"unprocessed"===l||"unprocessed"!==l&&"delete-together"!==l?e.split(/\r?\n|\r(?!\n)/):"delete-together"===l?e.replace(/(?<=(^|\r?\n|\r(?!\n))(#+ |[ \t]*[\-+*] |[ \t]*\d+\. ).*)(\r?\n|\r(?!\n)){2}(?=#+ |[ \t]*[\-+*] |[ \t]*\d+\. )/g,"").replace(/\/\*[\s\S]*?(\*\/|$)/g,"").replace(/(?<=^|\r?\n|\r(?!\n))(#+ |[ \t]*[\-+*] |[ \t]*\d+\. |\/\/).*(\r?\n|\r(?!\n))/g,"").replace(/(?<=^|\r?\n|\r(?!\n))(?=.*:).*(\r?\n|\r(?!\n))|(?<=^|\r?\n|\r(?!\n))[ \t]*\\.*(\r?\n|\r(?!\n))/g,"").replace(/^(\r?\n|\r(?!\n))/,"").split(/\r?\n|\r(?!\n)/):void 0}async function p(e){async function r(e,r){return new Promise(p=>{function a(s){function g(n){c&&!l?n&&/^.+$/.test(e[t+1])?(e[t]=e[t].replace(/^[　 ]*/,""),t++,a()):n&&/^$/.test(e[t+1])?(e[t]=`${e[t].replace(/^[　 ]*/,"")}</p>`,c=!1,t++,a()):n?(t++,a()):(e[t]=`${e[t].replace(/^[　 ]*/,"")}</p>`,p(e)):c||l?!c&&l?(n&&""!==i&&!d.test(e[t])&&h.test(e[t])&&(e[t]=`${e[t].replace(/^[　 ]*/,"")}</p>`,l=!1,t++,a()),!n||""===i||d.test(e[t])||h.test(e[t])||(e[t]=`${e[t].replace(/^[　 ]*/,"")}`,t++,a(i)),n||(e[t]=`${e[t].replace(/^[　 ]*/,"")}</p>`,p(e))):(console.log("想定外の入力がありました"),t++,a()):n&&""===i&&/^(?<!\\)[　 ]?.+$/.test(e[t])&&/^(?<!\\)[　 ]?.+$/.test(e[t+1])?(e[t]=`${u}<p>${e[t]}`,c=!0,t++,a(i)):n&&""===i&&/^(?<!\\)[　 ]?.+$/.test(e[t])&&!/^(?<!\\)[　 ]?.+$/.test(e[t+1])?(e[t]=`${u}<p>${e[t]}</p>`,t++,a()):n&&""===i&&/^$/.test(e[t])?(e[t]={few:`${u}<p><br></p>`,paper:""}[r],t++,a()):n&&""===i&&/^([^　 ]?|(?<=\\)[　 ]?).*$/.test(e[t])?(e[t]=`${u}<p>${e[t].replace(/^\\/,"")}</p>`,t++,a()):n&&""!==i&&!/^$/.test(e[t])&&e[t].search(d)<e[t].search(h)?(e[t]=`${u}<p>${e[t]}</p>`,t++,a()):n&&""!==i&&!/^$/.test(e[t])&&e[t].search(d)>=e[t].search(h)?(e[t]=`${u}<p>${e[t]}`,l=!0,t++,a(i)):n?(console.log("想定外の入力がありました"),t++,a()):(e[t]={few:`<p>${e[t].replace(/^[　 ]*/,"").replace(/^$/,"<br>")}</p>`,paper:`<p>${e[t].replace(/^[　 ]*/,"").replace(/(^$)+/,"<br>")}</p>`}[r],p(e))}let u=0!==t?o:"",i=void 0!==s?s:n.test(e[t])?e[t].match(n)[0]:"",x=""!==i?$.filter(e=>e[0]===i)[0][1]:"",d=new RegExp(`^${i}`),h=new RegExp(`${x}$`);t!==e.length-1?g(!0):g(!1)}let t=0,c=!1,l=!1;a()})}let p=$.map(e=>e[0]).join(""),n=new RegExp(`^(?<![　 ])[${p}]`);return"normal"===t?e.map(e=>e.replace(/^(.+)$/,"<p>$1</p>").replace(/^$/,"<p><br></p>")):"few"===t?r(e,"few"):"paper"===t?r(e,"paper"):"raw"===t||"normal"!==t&&"few"!==t&&"paper"!==t?e:void 0}function n(e){return e=e.join(""),"parse"===c?e.replace(/[|｜](.+?)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)《(.+?)》/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)\(((\p{scx=Hira}|\p{scx=Kana})+)\)/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)（((\p{scx=Hira}|\p{scx=Kana})+)）/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"<ruby>$1<rt>$2</rt></ruby>"):"open"===c?e.replace(/[|｜].+?《(.+?)》/g,"$1").replace(/(?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+《(.+?)》/gu,"$1").replace(/(?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+\(((\p{scx=Hira}|\p{scx=Kana})+)\)/gu,"$1").replace(/(?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+（((\p{scx=Hira}|\p{scx=Kana})+)）/gu,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#.+?__(.+?)__#/g,"$1"):"delete"===c?e.replace(/[|｜](.+?)《(.+?)》/g,"$1").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)《(.+?)》/g,"$1").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)\(((\p{scx=Hira}|\p{scx=Kana})+)\)/gu,"$1").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)（((\p{scx=Hira}|\p{scx=Kana})+)）/gu,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"$1"):"raw"===c?e:void 0}let a=void 0===e.src?"":e.src,t=void 0===e.newLineMode?"normal":e.newLineMode,c=void 0===e.rubyMode?"parse":e.rubyMode,$=(e.parenthesis,[["「","」"],["『","』"],["（","）"]]),l=void 0===e.comment?"delete-together":e.comment,s={n:(a.match(/(?<!\r)\n/g)||[]).length,r:(a.match(/\r(?!\n)/g)||[]).length,rn:(a.match(/\r\n/g)||[]).length},o=s.n>=s.r?s.n>=s.rn?"\n":"\r\n":s.r<=s.rn?"\r\n":"\r";return p(r(a)).then(e=>n(e))}