function novelparse(e){function r(e){return"unprocessed"===s||"unprocessed"!==s&&"delete-together"!==s?e.split(/\r?\n|\r(?!\n)/):"delete-together"===s?e.replace(/(?<=(^|\r?\n|\r(?!\n))(#+ |[ \t]*[\-+*] |[ \t]*\d+\. ).*)(\r?\n|\r(?!\n)){2}(?=#+ |[ \t]*[\-+*] |[ \t]*\d+\. )/g,"").replace(/\/\*[\s\S]*?(\*\/|$)/g,"").replace(/(?<=^|\r?\n|\r(?!\n))(#+ |[ \t]*[\-+*] |[ \t]*\d+\. |\/\/).*(\r?\n|\r(?!\n))/g,"").replace(/(?<=^|\r?\n|\r(?!\n))(?=.*:).*(\r?\n|\r(?!\n))|(?<=^|\r?\n|\r(?!\n))[ \t]*\\.*(\r?\n|\r(?!\n))/g,"").replace(/^(\r?\n|\r(?!\n))/,"").split(/\r?\n|\r(?!\n)/):void 0}async function n(e){async function r(e){return new Promise(r=>{function n(s){function l(p){a&&!c?p&&/^.+$/.test(e[t+1])?(e[t]=e[t].replace(/^[　 ]*/,""),t++,n()):p&&/^$/.test(e[t+1])?(e[t]=`${e[t].replace(/^[　 ]*/,"")}</p>`,a=!1,t++,n()):p?(t++,n()):(e[t]=`${e[t].replace(/^[　 ]*/,"")}</p>`,r(e)):a||c?!a&&c?(p&&""!==u&&!x.test(e[t])&&d.test(e[t])&&(e[t]=`${e[t].replace(/^[　 ]*/,"")}</p>`,c=!1,t++,n()),!p||""===u||x.test(e[t])||d.test(e[t])||(e[t]=`${e[t].replace(/^[　 ]*/,"")}`,t++,n(u)),p||(e[t]=`${e[t].replace(/^[　 ]*/,"")}</p>`,r(e))):(console.log("想定外の入力がありました"),t++,n()):p&&""===u&&/^(?<!\\)[　 ]?.+$/.test(e[t])&&/^(?<!\\)[　 ]?.+$/.test(e[t+1])?(e[t]=`${g}<p>${e[t]}`,a=!0,t++,n(u)):p&&""===u&&/^(?<!\\)[　 ]?.+$/.test(e[t])&&!/^(?<!\\)[　 ]?.+$/.test(e[t+1])?(e[t]=`${g}<p>${e[t]}</p>`,t++,n()):p&&""===u&&/^$/.test(e[t])?(e[t]=`${g}<p><br></p>`,t++,n()):p&&""===u&&/^([^　 ]?|(?<=\\)[　 ]?).*$/.test(e[t])?(e[t]=`${g}<p>${e[t].replace(/^\\/,"")}</p>`,t++,n()):p&&""!==u&&!/^$/.test(e[t])&&e[t].search(x)<e[t].search(d)?(e[t]=`${g}<p>${e[t]}</p>`,t++,n()):p&&""!==u&&!/^$/.test(e[t])&&e[t].search(x)>=e[t].search(d)?(e[t]=`${g}<p>${e[t]}`,c=!0,t++,n(u)):p?(console.log("想定外の入力がありました"),t++,n()):(e[t]=`<p>${e[t].replace(/^[　 ]*/,"").replace(/^$/,"<br>")}</p>`,r(e))}let g=0!==t?o:"",u=void 0!==s?s:p.test(e[t])?e[t].match(p)[0]:"",i=""!==u?$.filter(e=>e[0]===u)[0][1]:"",x=new RegExp(`^${u}`),d=new RegExp(`${i}$`);t!==e.length-1?l(!0):l(!1)}let t=0,a=!1,c=!1;n()})}let n=$.map(e=>e[0]).join(""),p=new RegExp(`^(?<![　 ])[${n}]`);return"normal"===a?e.map(e=>e.replace(/^(.+)$/,"<p>$1</p>").replace(/^$/,"<p><br></p>")):"few"===a?r(e):"raw"===a||"normal"!==a&&"few"!==a?e:void 0}function p(e){return e=e.join(""),"parse"===c?e.replace(/[|｜](.+?)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)《(.+?)》/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)\(((\p{scx=Hira}|\p{scx=Kana})+)\)/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)（((\p{scx=Hira}|\p{scx=Kana})+)）/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"<ruby>$1<rt>$2</rt></ruby>"):"open"===c?e.replace(/[|｜].+?《(.+?)》/g,"$1").replace(/(?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+《(.+?)》/gu,"$1").replace(/(?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+\(((\p{scx=Hira}|\p{scx=Kana})+)\)/gu,"$1").replace(/(?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+（((\p{scx=Hira}|\p{scx=Kana})+)）/gu,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#.+?__(.+?)__#/g,"$1"):"delete"===c?e.replace(/[|｜](.+?)《(.+?)》/g,"$1").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)《(.+?)》/g,"$1").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)\(((\p{scx=Hira}|\p{scx=Kana})+)\)/gu,"$1").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)（((\p{scx=Hira}|\p{scx=Kana})+)）/gu,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"$1"):"raw"===c?e:void 0}let t=void 0===e.src?"":e.src,a=void 0===e.newLineMode?"normal":e.newLineMode,c=void 0===e.rubyMode?"parse":e.rubyMode,$=(e.parenthesis,[["「","」"],["『","』"],["（","）"]]),s=void 0===e.comment?"delete-together":e.comment,l={n:(t.match(/(?<!\r)\n/g)||[]).length,r:(t.match(/\r(?!\n)/g)||[]).length,rn:(t.match(/\r\n/g)||[]).length},o=l.n>=l.r?l.n>=l.rn?"\n":"\r\n":l.r<=l.rn?"\r\n":"\r";return n(r(t)).then(e=>p(e))}