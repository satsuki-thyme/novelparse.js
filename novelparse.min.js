function novelparse(e){function r(e){return"unprocessed"===s||"unprocessed"!==s&&"delete-together"!==s?e.split(/\r?\n|\r(?!\n)/):"delete-together"===s?e.replace(/(?<=(^|\r?\n|\r(?!\n))(#+ |[ \t]*[\-+*] |[ \t]*\d+\. ).*)(\r?\n|\r(?!\n)){2}(?=#+ |[ \t]*[\-+*] |[ \t]*\d+\. )/g,"").replace(/\/\*[\s\S]*?(\*\/|$)/g,"").replace(/(?<=^|\r?\n|\r(?!\n))(#+ |[ \t]*[\-+*] |[ \t]*\d+\. |\/\/).*(\r?\n|\r(?!\n))/g,"").replace(/(?<=^|\r?\n|\r(?!\n))(?=.*:).*(\r?\n|\r(?!\n))|(?<=^|\r?\n|\r(?!\n))[ \t]*\\.*(\r?\n|\r(?!\n))/g,"").replace(/^(\r?\n|\r(?!\n))/,"").split(/\r?\n|\r(?!\n)/):void 0}async function p(e){async function r(e,r){return new Promise(p=>{function t(g){function u(n){c&&!s?n&&/^.+$/.test(e[a+1])?(e[a]=e[a].replace(/^[　 ]*/,""),l=!1,a++,t()):n&&/^$/.test(e[a+1])?(e[a]=`${e[a].replace(/^[　 ]*/,"")}</p>`,c=!1,l=!1,a++,t()):n?(a++,t()):(e[a]=`${e[a].replace(/^[　 ]*/,"")}</p>`,p(e)):c||s?!c&&s?(n&&""!==x&&!b.test(e[a])&&h.test(e[a])&&(e[a]=`${e[a].replace(/^[　 ]*/,"")}</p>`,s=!1,l=!1,a++,t()),!n||""===x||b.test(e[a])||h.test(e[a])||(e[a]=`${e[a].replace(/^[　 ]*/,"")}`,l=!1,a++,t(x)),n||(e[a]=`${e[a].replace(/^[　 ]*/,"")}</p>`,p(e))):(console.log("想定外の入力がありました"),a++,t()):n&&""===x&&/^(?<!\\)[　 ]?.+$/.test(e[a])&&/^(?<!\\)[　 ]?.+$/.test(e[a+1])?(e[a]=`${i}<p>${e[a]}`,c=!0,l=!1,a++,t(x)):n&&""===x&&/^(?<!\\)[　 ]?.+$/.test(e[a])&&!/^(?<!\\)[　 ]?.+$/.test(e[a+1])?(e[a]=`${i}<p>${e[a]}</p>`,l=!1,a++,t()):n&&""===x&&/^$/.test(e[a])?(e[a]={false:{false:{paper:"",few:`${i}<p><br></p>`}[r],true:`${i}<p><br>`}[/^$/.test(e[a+1])],true:{false:{paper:"</p>",few:"<br></p>"}[r],true:"<br>"}[/^$/.test(e[a+1])]}[l],l=!0,a++,t()):n&&""===x&&/^([^　 ]?|(?<=\\)[　 ]?).*$/.test(e[a])?(e[a]=`${i}<p>${e[a].replace(/^\\/,"")}</p>`,l=!1,a++,t()):n&&""!==x&&!/^$/.test(e[a])&&e[a].search(b)<e[a].search(h)?(e[a]=`${i}<p>${e[a]}</p>`,l=!1,a++,t()):n&&""!==x&&!/^$/.test(e[a])&&e[a].search(b)>=e[a].search(h)?(e[a]=`${i}<p>${e[a]}`,s=!0,l=!1,a++,t(x)):n?(console.log("想定外の入力がありました"),a++,t()):(e[a]=`<p>${e[a].replace(/^[　 ]*/,"")}</p>`,p(e))}let i=0!==a?o:"",x=void 0!==g?g:n.test(e[a])?e[a].match(n)[0]:"",d=""!==x?$.filter(e=>e[0]===x)[0][1]:"",b=new RegExp(`^${x}`),h=new RegExp(`${d}$`);a!==e.length-1?u(!0):u(!1)}let a=0,c=!1,s=!1,l=!1;t()})}let p=$.map(e=>e[0]).join(""),n=new RegExp(`^(?<![　 ])[${p}]`);return"normal"===a?e.map(e=>e.replace(/^(.+)$/,"<p>$1</p>").replace(/^$/,"<p><br></p>")):"few"===a?r(e,"few"):"paper"===a?r(e,"paper"):"raw"===a||"normal"!==a&&"few"!==a&&"paper"!==a?e:void 0}function n(e){return e=e.join(""),"parse"===c?e.replace(/[|｜](.+?)《(.+?)》/g,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)《(.+?)》/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)\(((\p{scx=Hira}|\p{scx=Kana})+)\)/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)（((\p{scx=Hira}|\p{scx=Kana})+)）/gu,"<ruby>$1<rt>$2</rt></ruby>").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"<ruby>$1<rt>$2</rt></ruby>"):"open"===c?e.replace(/[|｜].+?《(.+?)》/g,"$1").replace(/(?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+《(.+?)》/gu,"$1").replace(/(?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+\(((\p{scx=Hira}|\p{scx=Kana})+)\)/gu,"$1").replace(/(?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+（((\p{scx=Hira}|\p{scx=Kana})+)）/gu,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#.+?__(.+?)__#/g,"$1"):"delete"===c?e.replace(/[|｜](.+?)《(.+?)》/g,"$1").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)《(.+?)》/g,"$1").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)\(((\p{scx=Hira}|\p{scx=Kana})+)\)/gu,"$1").replace(/((?![〜、。〈〉《》「」『』【】〔〕〖〗〘〙〃〆・〓])\p{scx=Han}+)（((\p{scx=Hira}|\p{scx=Kana})+)）/gu,"$1").replace(/[|｜]([《\(（])(.+?)([》\)）])/g,"$1$2$3").replace(/#(.+?)__(.+?)__#/g,"$1"):"raw"===c?e:void 0}let t=void 0===e.src?"":e.src,a=void 0===e.newLineMode?"normal":e.newLineMode,c=void 0===e.rubyMode?"parse":e.rubyMode,$=(e.parenthesis,[["「","」"],["『","』"],["（","）"]]),s=void 0===e.comment?"delete-together":e.comment,l={n:(t.match(/(?<!\r)\n/g)||[]).length,r:(t.match(/\r(?!\n)/g)||[]).length,rn:(t.match(/\r\n/g)||[]).length},o=l.n>=l.r?l.n>=l.rn?"\n":"\r\n":l.r<=l.rn?"\r\n":"\r";return p(r(t)).then(e=>n(e))}